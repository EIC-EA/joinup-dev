<?xml version="1.0" encoding="UTF-8" ?>

<project name="ContinuousPHP" default="help">

    <echo msg="Loading AWS additional tasks." />
    <import file="./vendor/continuousphp/aws-sdk-phing/tasks.xml" />
    <property name="aws.profile" value="" />

    <echo msg="Turn environment variable into a phing property" />
    <taskdef name="env2property" classname="\DrupalProject\Phing\EnvironmentVarAsProperty" />

    <echo msg="Loading infra additional tasks." />
    <import file="./vendor/ec-europa/infra/infra.xml" />

    <!-- Run Behat tests. -->
    <!-- Use this target to run tests with increased verbosity on ContinuousPHP to help debugging. -->
    <target name="run-behat-tests" description="Run Behat tests.">
        <behat
            executable="${behat.bin}"
            config="${behat.yml.path}"
            strict="${behat.options.strict}"
            verbose="${behat.options.verbosity}"
        />
    </target>

    <target name="setup-continuousphp"
            depends="check-continuousphp">
        <echo msg="Set the virtuoso checkpoint to -1. Do not use a checkpoint for CPHP testing."/>
        <phingcall target="set-virtuoso-checkpoint">
            <property name="interval" value="-1"/>
        </phingcall>
        <echo message="Put the odbc configuration file in the home folder where CPHP can find it" />
        <copy
            file="./vendor/ec-europa/infra/continuousphp/odbc.ini"
            tofile="${user.home}/.odbc.ini"
            overwrite="true" />
        <echo message="Create Solr index" />
        <exec dir="${project.basedir}"
              command="sudo curl -o /opt/solr/search_api_solr.tar.gz https://ftp.drupal.org/files/projects/search_api_solr-8.x-1.0-alpha4.tar.gz;
sudo tar xvzf /opt/solr/search_api_solr.tar.gz -C /opt/solr;
sudo /opt/solr/bin/solr create_core -c drupal_published;
sudo mkdir /opt/solr/server/solr/drupal_published;
sudo rsync -avz /opt/solr/search_api_solr/solr-conf/6.x/ /opt/solr/server/solr/drupal_published/conf/;
sudo /opt/solr/bin/solr create_core -c drupal_unpublished;
sudo mkdir /opt/solr/server/solr/drupal_unpublished;
sudo rsync -avz /opt/solr/search_api_solr/solr-conf/6.x/ /opt/solr/server/solr/drupal_unpublished/conf/"
              checkreturn="true"
              passthru="true" />
        <echo message="Report Solr status" />
        <exec dir="${project.basedir}"
              command="sudo /opt/solr/bin/solr status"
              checkreturn="true"
              passthru="true" />
        <echo message="Restart Solr" />
        <exec dir="${project.basedir}"
              command="sudo /opt/solr/bin/solr restart"
              checkreturn="true"
              passthru="true"
              spawn="true" />
    </target>

    <target name="check-continuousphp">
        <echo message="Check if we are running on ContinuousPHP" />
        <if>
            <not>
                <available file="/home/cphp" type="dir" property="environment.cphp" />
            </not>
            <then>
                <fail message="Only run this target on a ContinuousPHP test environment" />
            </then>
        </if>
    </target>

    <target name="build-continuousphp" depends="sass-compiler-requirements">
        <echo message="Install the SASS compiler" />
        <exec dir="${project.basedir}"
              command="sudo gem install sass"
              checkreturn="true"
              passthru="true" />
        <!-- Set environment variables as extra properties through cloudformation -->
        <env2property prefix="cphp" phingproperty="cloudformation.properties" />
        <echo message="Copy CPHP pipeline variables to local properties file" />
        <echoproperties prefix="cphp." destfile="build.properties.local" />
        <exec dir="${project.basedir}"
              command="sed -i 's/^cphp\.//' build.properties.local"
              checkreturn="true"
              passthru="true" />
    </target>


    <target name="sass-compiler-requirements">
        <exec command="gem --version"
              dir="${project.basedir}"
              checkreturn="false"
              returnProperty="rubygems.missed"
        />

        <if>
            <not>
                <equals arg1="${rubygems.missed}" arg2="0"/>
            </not>
            <then>
                <exec command="sudo apt-get --version"
                      returnProperty="check.is_debian"/>
                <if>
                    <not>
                        <equals arg1="${check.is_debian}" arg2="0"/>
                    </not>
                    <then>
                        <fail message="Automatic install of RubyGems is supported only for Debian systems. Install manually RubyGems and run again this Phing target."/>
                    </then>
                </if>

                <echo message="Installing RubyGems"/>
                <exec command="sudo apt-get update &amp;&amp; sudo apt-get install -y ruby-dev ruby"
                      checkreturn="true"
                      passthru="true"
                />
            </then>
        </if>

        <exec command="gem --version"
              dir="${project.basedir}"
              outputProperty="rubygems.version"
        />
    </target>

    <!-- provision new demo/test stack on AWS -->
    <target name="provision-stack"
            description="Provision a stack on AWS"
            depends="setup-aws, run-stack, setup-deployment-group" />

</project>
